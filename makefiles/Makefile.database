##@ üóÑÔ∏è  Banco de Dados - Migrations

migrate: ## Executa migrations pendentes
	@echo "$(GREEN)üóÑÔ∏è  Executando migrations...$(NC)"
	docker compose exec php php artisan migrate

migrate-fresh: ## Dropa tudo e recria (‚ö†Ô∏è APAGA DADOS!)
	@echo "$(RED)‚ö†Ô∏è  ATEN√á√ÉO: Isso vai apagar todos os dados!$(NC)"
	@read -p "Tem certeza? [s/N]: " confirm; \
	if [ "$$confirm" = "s" ] || [ "$$confirm" = "S" ]; then \
		docker compose exec php php artisan migrate:fresh; \
	else \
		echo "Cancelado."; \
	fi

migrate-fresh-seed: ## Dropa, recria e popula o banco
	@echo "$(RED)‚ö†Ô∏è  ATEN√á√ÉO: Isso vai apagar todos os dados!$(NC)"
	@read -p "Tem certeza? [s/N]: " confirm; \
	if [ "$$confirm" = "s" ] || [ "$$confirm" = "S" ]; then \
		docker compose exec php php artisan migrate:fresh --seed; \
	else \
		echo "Cancelado."; \
	fi

migrate-refresh: ## Rollback e re-executa todas migrations
	docker compose exec php php artisan migrate:refresh

migrate-refresh-seed: ## Rollback, re-executa e popula
	docker compose exec php php artisan migrate:refresh --seed

migrate-rollback: ## Desfaz √∫ltima migra√ß√£o
	docker compose exec php php artisan migrate:rollback

migrate-rollback-step: ## Desfaz N migra√ß√µes
	@read -p "Quantos steps desfazer? " steps; \
	docker compose exec php php artisan migrate:rollback --step=$$steps

migrate-reset: ## Desfaz todas as migra√ß√µes
	docker compose exec php php artisan migrate:reset

migrate-status: ## Mostra status das migrations
	docker compose exec php php artisan migrate:status

migrate-install: ## Instala reposit√≥rio de migrations
	docker compose exec php php artisan migrate:install

schema-dump: ## Dump do schema do banco de dados
	docker compose exec php php artisan schema:dump


##@ üóÑÔ∏è  Banco de Dados - Opera√ß√µes

db-show: ## Mostra informa√ß√µes do banco
	docker compose exec php php artisan db:show

db-table: ## Mostra estrutura de uma tabela
	@read -p "Nome da tabela: " table; \
	docker compose exec php php artisan db:table $$table

db-monitor: ## Monitora conex√µes do banco
	docker compose exec php php artisan db:monitor

db-wipe: ## Limpa todas as tabelas (‚ö†Ô∏è APAGA DADOS!)
	@echo "$(RED)‚ö†Ô∏è  ATEN√á√ÉO: Isso vai apagar todos os dados!$(NC)"
	@read -p "Tem certeza? [s/N]: " confirm; \
	if [ "$$confirm" = "s" ] || [ "$$confirm" = "S" ]; then \
		docker compose exec php php artisan db:wipe; \
	else \
		echo "Cancelado."; \
	fi

seed: ## Executa todos os seeders
	@echo "$(GREEN)üå± Executando seeders...$(NC)"
	docker compose exec php php artisan db:seed

seed-class: ## Executa um seeder espec√≠fico
	@read -p "Nome do seeder: " seeder; \
	docker compose exec php php artisan db:seed --class=$$seeder


##@ üíæ Backup & Restore - MySQL

backup-db: ## Faz backup do banco MySQL
	@echo "$(GREEN)üíæ Criando backup do MySQL...$(NC)"
	@mkdir -p backups
	@timestamp=$$(date +%Y%m%d_%H%M%S); \
	docker compose exec mysql mysqldump -u root -proot db_laravel > backups/mysql_backup_$$timestamp.sql && \
	echo "$(GREEN)‚úÖ Backup salvo em: backups/mysql_backup_$$timestamp.sql$(NC)"

restore-db: ## Restaura backup do MySQL
	@echo "$(YELLOW)Arquivos dispon√≠veis em backups/:$(NC)"
	@ls -lh backups/*.sql 2>/dev/null || echo "Nenhum backup encontrado"
	@read -p "Nome do arquivo (sem o path): " file; \
	if [ -f "backups/$$file" ]; then \
		echo "$(YELLOW)Restaurando backup...$(NC)"; \
		docker compose exec -T mysql mysql -u root -proot db_laravel < backups/$$file && \
		echo "$(GREEN)‚úÖ Backup restaurado!$(NC)"; \
	else \
		echo "$(RED)‚ùå Arquivo n√£o encontrado!$(NC)"; \
	fi


##@ üíæ Backup & Restore - PostgreSQL

backup-postgres: ## Faz backup do banco PostgreSQL
	@echo "$(GREEN)üíæ Criando backup do PostgreSQL...$(NC)"
	@mkdir -p backups
	@timestamp=$$(date +%Y%m%d_%H%M%S); \
	docker compose exec postgres pg_dump -U developer db_laravel > backups/postgres_backup_$$timestamp.sql && \
	echo "$(GREEN)‚úÖ Backup salvo em: backups/postgres_backup_$$timestamp.sql$(NC)"

restore-postgres: ## Restaura backup do PostgreSQL
	@echo "$(YELLOW)Arquivos dispon√≠veis em backups/:$(NC)"
	@ls -lh backups/*.sql 2>/dev/null || echo "Nenhum backup encontrado"
	@read -p "Nome do arquivo (sem o path): " file; \
	if [ -f "backups/$$file" ]; then \
		echo "$(YELLOW)Restaurando backup...$(NC)"; \
		docker compose exec -T postgres psql -U developer db_laravel < backups/$$file && \
		echo "$(GREEN)‚úÖ Backup restaurado!$(NC)"; \
	else \
		echo "$(RED)‚ùå Arquivo n√£o encontrado!$(NC)"; \
	fi


##@ üíæ Backup & Restore - MongoDB

backup-mongodb: ## Faz backup do banco MongoDB
	@echo "$(GREEN)üíæ Criando backup do MongoDB...$(NC)"
	@mkdir -p backups
	@timestamp=$$(date +%Y%m%d_%H%M%S); \
	docker compose exec mongodb mongodump --username=developer --password=123456 --authenticationDatabase=admin --db=db_laravel --out=/tmp/backup && \
	docker compose cp mongodb:/tmp/backup backups/mongodb_backup_$$timestamp && \
	echo "$(GREEN)‚úÖ Backup salvo em: backups/mongodb_backup_$$timestamp$(NC)"

restore-mongodb: ## Restaura backup do MongoDB
	@echo "$(YELLOW)Diret√≥rios dispon√≠veis em backups/:$(NC)"
	@ls -d backups/mongodb_backup_* 2>/dev/null || echo "Nenhum backup encontrado"
	@read -p "Nome do diret√≥rio (sem o path): " dir; \
	if [ -d "backups/$$dir" ]; then \
		echo "$(YELLOW)Restaurando backup...$(NC)"; \
		docker compose cp backups/$$dir mongodb:/tmp/restore && \
		docker compose exec mongodb mongorestore --username=developer --password=123456 --authenticationDatabase=admin --db=db_laravel /tmp/restore/db_laravel && \
		echo "$(GREEN)‚úÖ Backup restaurado!$(NC)"; \
	else \
		echo "$(RED)‚ùå Diret√≥rio n√£o encontrado!$(NC)"; \
	fi

