##@ ðŸ” Qualidade de CÃ³digo - PHP Insights

phpinsights-install: ## Instala PHP Insights
	@echo "$(GREEN)ðŸ“¦ Instalando PHP Insights...$(NC)"
	docker compose exec php composer require --dev nunomaduro/phpinsights
	@echo "$(GREEN)âœ… PHP Insights instalado!$(NC)"
	@echo "$(YELLOW)ðŸ’¡ Execute: make phpinsights-analyze$(NC)"

phpinsights-analyze: ## Analisa cÃ³digo com PHP Insights
	@echo "$(GREEN)ðŸ” Analisando cÃ³digo com PHP Insights...$(NC)"
	docker compose exec php ./vendor/bin/phpinsights analyse backend/app --min-quality=80 --min-complexity=80 --min-architecture=80 --min-style=80 || true

phpinsights-analyze-simple: ## AnÃ¡lise simples (sem mÃ©tricas mÃ­nimas)
	@echo "$(GREEN)ðŸ” AnÃ¡lise simples com PHP Insights...$(NC)"
	docker compose exec php ./vendor/bin/phpinsights analyse backend/app

phpinsights-fix: ## Corrige problemas automaticamente (quando possÃ­vel)
	@echo "$(YELLOW)ðŸ”§ Corrigindo problemas automaticamente...$(NC)"
	docker compose exec php ./vendor/bin/phpinsights analyse backend/app --fix || true

phpinsights-config: ## Gera arquivo de configuraÃ§Ã£o phpinsights.php
	@echo "$(GREEN)âš™ï¸  Gerando configuraÃ§Ã£o do PHP Insights...$(NC)"
	docker compose exec php ./vendor/bin/phpinsights --init || true


##@ ðŸŽ¯ PHPStan - AnÃ¡lise EstÃ¡tica

phpstan-install: ## Instala PHPStan
	@echo "$(GREEN)ðŸ“¦ Instalando PHPStan...$(NC)"
	docker compose exec php composer require --dev phpstan/phpstan phpstan/extension-installer
	@echo "$(GREEN)âœ… PHPStan instalado!$(NC)"

phpstan-analyze: ## Analisa cÃ³digo com PHPStan (nÃ­vel 0)
	@echo "$(GREEN)ðŸ” Analisando cÃ³digo com PHPStan...$(NC)"
	docker compose exec php ./vendor/bin/phpstan analyse backend/app --memory-limit=2G || true

phpstan-analyze-level: ## Analisa com nÃ­vel especÃ­fico (0-9)
	@read -p "NÃ­vel de anÃ¡lise (0-9, padrÃ£o: 5): " level; \
	level=$${level:-5}; \
	echo "$(GREEN)ðŸ” Analisando com nÃ­vel $$level...$(NC)"; \
	docker compose exec php ./vendor/bin/phpstan analyse backend/app --level=$$level --memory-limit=2G || true

phpstan-analyze-strict: ## AnÃ¡lise rigorosa (nÃ­vel 9)
	@echo "$(GREEN)ðŸ” AnÃ¡lise rigorosa com PHPStan (nÃ­vel 9)...$(NC)"
	docker compose exec php ./vendor/bin/phpstan analyse backend/app --level=9 --memory-limit=2G || true

phpstan-baseline: ## Gera baseline para ignorar erros existentes
	@echo "$(YELLOW)ðŸ“ Gerando baseline do PHPStan...$(NC)"
	docker compose exec php ./vendor/bin/phpstan analyse backend/app --generate-baseline --memory-limit=2G || true

phpstan-clear-result-cache: ## Limpa cache de resultados do PHPStan
	@echo "$(YELLOW)ðŸ§¹ Limpando cache do PHPStan...$(NC)"
	docker compose exec php ./vendor/bin/phpstan clear-result-cache || true


##@ ðŸŽ¨ PHP CS Fixer - FormataÃ§Ã£o de CÃ³digo

phpcs-install: ## Instala PHP CS Fixer
	@echo "$(GREEN)ðŸ“¦ Instalando PHP CS Fixer...$(NC)"
	docker compose exec php composer require --dev friendsofphp/php-cs-fixer
	@echo "$(GREEN)âœ… PHP CS Fixer instalado!$(NC)"

phpcs-check: ## Verifica estilo de cÃ³digo (sem alterar)
	@echo "$(GREEN)ðŸ” Verificando estilo de cÃ³digo...$(NC)"
	docker compose exec php ./vendor/bin/php-cs-fixer fix --dry-run --diff backend/app || true

phpcs-fix: ## Corrige estilo de cÃ³digo automaticamente
	@echo "$(GREEN)ðŸ”§ Corrigindo estilo de cÃ³digo...$(NC)"
	docker compose exec php ./vendor/bin/php-cs-fixer fix backend/app

phpcs-config: ## Gera arquivo de configuraÃ§Ã£o .php-cs-fixer.php
	@echo "$(GREEN)âš™ï¸  Gerando configuraÃ§Ã£o do PHP CS Fixer...$(NC)"
	docker compose exec php ./vendor/bin/php-cs-fixer --init || true


##@ ðŸŽ¨ Laravel Pint - FormataÃ§Ã£o Moderna

pint-install: ## Instala Laravel Pint
	@echo "$(GREEN)ðŸ“¦ Instalando Laravel Pint...$(NC)"
	docker compose exec php composer require --dev laravel/pint
	@echo "$(GREEN)âœ… Laravel Pint instalado!$(NC)"

pint-check: ## Verifica formataÃ§Ã£o (sem alterar)
	@echo "$(GREEN)ðŸ” Verificando formataÃ§Ã£o com Pint...$(NC)"
	docker compose exec php ./vendor/bin/pint --test backend/app || true

pint-fix: ## Corrige formataÃ§Ã£o automaticamente
	@echo "$(GREEN)ðŸ”§ Corrigindo formataÃ§Ã£o com Pint...$(NC)"
	docker compose exec php ./vendor/bin/pint backend/app


##@ ðŸ› PHPMD - PHP Mess Detector

phpmd-install: ## Instala PHPMD
	@echo "$(GREEN)ðŸ“¦ Instalando PHPMD...$(NC)"
	docker compose exec php composer require --dev phpmd/phpmd
	@echo "$(GREEN)âœ… PHPMD instalado!$(NC)"

phpmd-analyze: ## Analisa cÃ³digo com PHPMD
	@echo "$(GREEN)ðŸ” Analisando cÃ³digo com PHPMD...$(NC)"
	docker compose exec php ./vendor/bin/phpmd backend/app text codesize,unusedcode,naming,design,controversial,cleancode || true

phpmd-analyze-xml: ## AnÃ¡lise PHPMD em formato XML
	@read -p "Arquivo de saÃ­da (ex: phpmd-report.xml): " file; \
	echo "$(GREEN)ðŸ” Gerando relatÃ³rio XML...$(NC)"; \
	docker compose exec php ./vendor/bin/phpmd backend/app xml codesize,unusedcode,naming,design,controversial,cleancode > $$file || true


##@ ðŸ“Š Psalm - AnÃ¡lise EstÃ¡tica AvanÃ§ada

psalm-install: ## Instala Psalm
	@echo "$(GREEN)ðŸ“¦ Instalando Psalm...$(NC)"
	docker compose exec php composer require --dev vimeo/psalm
	@echo "$(GREEN)âœ… Psalm instalado!$(NC)"

psalm-init: ## Inicializa Psalm no projeto
	@echo "$(GREEN)âš™ï¸  Inicializando Psalm...$(NC)"
	docker compose exec php ./vendor/bin/psalm --init || true

psalm-analyze: ## Analisa cÃ³digo com Psalm
	@echo "$(GREEN)ðŸ” Analisando cÃ³digo com Psalm...$(NC)"
	docker compose exec php ./vendor/bin/psalm --memory-limit=2G || true

psalm-baseline: ## Gera baseline do Psalm
	@echo "$(YELLOW)ðŸ“ Gerando baseline do Psalm...$(NC)"
	docker compose exec php ./vendor/bin/psalm --set-baseline=psalm-baseline.xml || true

psalm-clear-cache: ## Limpa cache do Psalm
	@echo "$(YELLOW)ðŸ§¹ Limpando cache do Psalm...$(NC)"
	docker compose exec php ./vendor/bin/psalm --clear-cache || true


##@ ðŸ”§ AnÃ¡lise de Complexidade

complexity-check: ## Verifica complexidade ciclomÃ¡tica
	@echo "$(GREEN)ðŸ” Verificando complexidade do cÃ³digo...$(NC)"
	@if command -v phploc > /dev/null 2>&1 || docker compose exec php composer show | grep -q phploc; then \
		docker compose exec php ./vendor/bin/phploc backend/app || true; \
	else \
		echo "$(YELLOW)ðŸ’¡ Instale phploc: make composer-require-dev package=phploc/phploc$(NC)"; \
	fi

phploc-install: ## Instala phploc (anÃ¡lise de mÃ©tricas)
	@echo "$(GREEN)ðŸ“¦ Instalando phploc...$(NC)"
	docker compose exec php composer require --dev phploc/phploc
	@echo "$(GREEN)âœ… phploc instalado!$(NC)"

phploc-analyze: ## Analisa mÃ©tricas do cÃ³digo
	@echo "$(GREEN)ðŸ“Š Analisando mÃ©tricas com phploc...$(NC)"
	docker compose exec php ./vendor/bin/phploc backend/app || true


##@ ðŸ› ï¸ VerificaÃ§Ã£o de DependÃªncias

composer-audit: ## Verifica vulnerabilidades (Composer)
	@echo "$(GREEN)ðŸ”’ Verificando vulnerabilidades...$(NC)"
	docker compose exec php composer audit

composer-audit-format: ## Auditoria em formato JSON
	@echo "$(GREEN)ðŸ”’ Verificando vulnerabilidades (JSON)...$(NC)"
	docker compose exec php composer audit --format=json || true


##@ ðŸŽ¯ Workflow Completo de Qualidade

quality-check: ## Executa todas as verificaÃ§Ãµes de qualidade
	@echo "$(BLUE)â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”$(NC)"
	@echo "$(GREEN)ðŸ” VerificaÃ§Ã£o Completa de Qualidade$(NC)"
	@echo "$(BLUE)â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”$(NC)"
	@echo ""
	@echo "$(YELLOW)1/5 Executando testes...$(NC)"
	$(MAKE) test || echo "$(YELLOW)âš ï¸  Testes nÃ£o passaram$(NC)"
	@echo ""
	@echo "$(YELLOW)2/5 Verificando estilo de cÃ³digo...$(NC)"
	$(MAKE) phpcs-check || echo "$(YELLOW)âš ï¸  PHP CS Fixer nÃ£o configurado$(NC)"
	@echo ""
	@echo "$(YELLOW)3/5 Analisando com PHPStan...$(NC)"
	$(MAKE) phpstan-analyze || echo "$(YELLOW)âš ï¸  PHPStan nÃ£o configurado$(NC)"
	@echo ""
	@echo "$(YELLOW)4/5 Verificando vulnerabilidades...$(NC)"
	$(MAKE) composer-audit || echo "$(YELLOW)âš ï¸  Auditoria nÃ£o disponÃ­vel$(NC)"
	@echo ""
	@echo "$(YELLOW)5/5 Gerando mÃ©tricas...$(NC)"
	$(MAKE) phploc-analyze || echo "$(YELLOW)âš ï¸  phploc nÃ£o configurado$(NC)"
	@echo ""
	@echo "$(GREEN)âœ… VerificaÃ§Ã£o de qualidade concluÃ­da!$(NC)"

quality-fix: ## Corrige automaticamente problemas de qualidade
	@echo "$(BLUE)â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”$(NC)"
	@echo "$(GREEN)ðŸ”§ CorreÃ§Ã£o AutomÃ¡tica de Qualidade$(NC)"
	@echo "$(BLUE)â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”$(NC)"
	@echo ""
	@echo "$(YELLOW)1/3 Corrigindo estilo com PHP CS Fixer...$(NC)"
	$(MAKE) phpcs-fix || echo "$(YELLOW)âš ï¸  PHP CS Fixer nÃ£o configurado$(NC)"
	@echo ""
	@echo "$(YELLOW)2/3 Corrigindo com PHP Insights...$(NC)"
	$(MAKE) phpinsights-fix || echo "$(YELLOW)âš ï¸  PHP Insights nÃ£o configurado$(NC)"
	@echo ""
	@echo "$(YELLOW)3/3 Formatando com Laravel Pint...$(NC)"
	$(MAKE) pint-fix || echo "$(YELLOW)âš ï¸  Laravel Pint nÃ£o configurado$(NC)"
	@echo ""
	@echo "$(GREEN)âœ… CorreÃ§Ã£o automÃ¡tica concluÃ­da!$(NC)"

quality-install-all: ## Instala todas as ferramentas de qualidade
	@echo "$(BLUE)â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”$(NC)"
	@echo "$(GREEN)ðŸ“¦ Instalando Todas as Ferramentas de Qualidade$(NC)"
	@echo "$(BLUE)â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”$(NC)"
	@echo ""
	@echo "$(YELLOW)Instalando PHP Insights...$(NC)"
	$(MAKE) phpinsights-install || true
	@echo ""
	@echo "$(YELLOW)Instalando PHPStan...$(NC)"
	$(MAKE) phpstan-install || true
	@echo ""
	@echo "$(YELLOW)Instalando PHP CS Fixer...$(NC)"
	$(MAKE) phpcs-install || true
	@echo ""
	@echo "$(YELLOW)Instalando Laravel Pint...$(NC)"
	$(MAKE) pint-install || true
	@echo ""
	@echo "$(YELLOW)Instalando PHPMD...$(NC)"
	$(MAKE) phpmd-install || true
	@echo ""
	@echo "$(YELLOW)Instalando phploc...$(NC)"
	$(MAKE) phploc-install || true
	@echo ""
	@echo "$(GREEN)âœ… InstalaÃ§Ã£o concluÃ­da!$(NC)"
	@echo "$(YELLOW)ðŸ’¡ Execute: make quality-check$(NC)"


##@ ðŸ“Š MÃ©tricas e RelatÃ³rios

code-metrics: ## Mostra mÃ©tricas gerais do cÃ³digo
	@echo "$(BLUE)â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”$(NC)"
	@echo "$(GREEN)ðŸ“Š MÃ©tricas do CÃ³digo$(NC)"
	@echo "$(BLUE)â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”$(NC)"
	@echo ""
	@echo "$(YELLOW)ðŸ“ Arquivos PHP:$(NC)"
	@find backend/app -name "*.php" 2>/dev/null | wc -l || echo "0"
	@echo ""
	@echo "$(YELLOW)ðŸ“ Linhas de cÃ³digo (estimado):$(NC)"
	@find backend/app -name "*.php" -exec cat {} \; 2>/dev/null | wc -l || echo "0"
	@echo ""
	@echo "$(YELLOW)ðŸ§ª Testes:$(NC)"
	@find backend/tests -name "*.php" 2>/dev/null | wc -l || echo "0"
	@echo ""
	@if docker compose exec php composer show | grep -q phploc; then \
		echo "$(YELLOW)ðŸ“Š AnÃ¡lise detalhada:$(NC)"; \
		docker compose exec php ./vendor/bin/phploc backend/app || true; \
	fi

